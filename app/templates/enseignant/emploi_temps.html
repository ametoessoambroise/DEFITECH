{% extends "base.html" %} {% block title %}{{ current_user.nom }} {{
current_user.prenom }} | DEFITECH{% endblock %} {% block extra_css %}
<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
{% endblock %} {% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="bg-white rounded-lg shadow">
    <div
      class="px-6 py-4 border-b border-gray-200 flex items-center justify-between"
    >
      <div>
        <h2 class="text-xl font-semibold text-gray-900">Mon Emploi du Temps</h2>
        <p class="text-sm text-gray-600 mt-1">
          Consultez votre planning hebdomadaire
        </p>
      </div>
      <button
        id="refresh-emploi"
        class="inline-flex items-center px-3 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
      >
        <i class="fas fa-sync-alt mr-2"></i>Actualiser
      </button>
    </div>

    <div class="p-6">
      <div class="overflow-x-auto">
        <!-- FullCalendar Container -->
        <div
          id="calendar-teacher-view"
          class="p-4 bg-white rounded-xl min-h-[700px]"
        ></div>

        <!-- Ancien tableau (Commenté)
        <table
          id="timetable-enseignant"
          class="min-w-full border border-gray-200 hidden"
        >
          <thead id="timetable-head-enseignant">
          </thead>
          <tbody
            id="timetable-body-enseignant"
            class="bg-white divide-y divide-gray-200"
          >
          </tbody>
        </table>
        -->
      </div>

      <!-- Légende -->
      <div class="mt-6 p-4 bg-gray-50 rounded-lg">
        <h4 class="font-medium text-gray-900 mb-3">Légende</h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="flex items-center">
            <div class="w-4 h-4 bg-blue-100 rounded mr-2"></div>
            <span class="text-sm text-gray-700">Cours magistral</span>
          </div>
          <div class="flex items-center">
            <div class="w-4 h-4 bg-pink-100 rounded mr-2"></div>
            <span class="text-sm text-gray-700">Travaux pratiques</span>
          </div>
          <div class="flex items-center">
            <div class="w-4 h-4 bg-red-100 rounded mr-2"></div>
            <span class="text-sm text-gray-700">Laboratoire</span>
          </div>
          <div class="flex items-center">
            <div class="w-4 h-4 bg-cyan-100 rounded mr-2"></div>
            <span class="text-sm text-gray-700">Sport</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const head = document.getElementById("timetable-head-enseignant");
    const body = document.getElementById("timetable-body-enseignant");
    const refreshBtn = document.getElementById("refresh-emploi");
    let isLoading = false;

    /*
    async function loadEmploiTempsEnseignant() {
      // ... (existing logic commented out)
    }
    loadEmploiTempsEnseignant();
    */

    // --- Nouvelle Logique FullCalendar Enseignant ---
    const calendarEl = document.getElementById("calendar-teacher-view");
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "timeGridWeek",
      locale: "fr",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "timeGridWeek,timeGridDay,listWeek",
      },
      firstDay: 1,
      slotMinTime: "07:00:00",
      slotMaxTime: "20:00:00",
      allDaySlot: false,
      height: "auto",
      themeSystem: "standard",
      events: async function (info, successCallback, failureCallback) {
        try {
          const response = await fetch(
            "{{ url_for('teachers.api_emploi_temps') }}"
          );
          const data = await response.json();

          const events = [];
          const dayMapping = {
            Lundi: 1,
            Mardi: 2,
            Mercredi: 3,
            Jeudi: 4,
            Vendredi: 5,
            Samedi: 6,
            Dimanche: 0,
          };

          const today = new Date();
          const firstDayOfWeek = new Date(today);
          firstDayOfWeek.setDate(
            today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)
          );

          data.creneaux.forEach((c) => {
            const dayOffset = dayMapping[c.jour];
            const eventDate = new Date(firstDayOfWeek);
            eventDate.setDate(firstDayOfWeek.getDate() + (dayOffset - 1));

            const times = c.horaire.split(" - ");
            if (times.length === 2) {
              const [startH, startM] = times[0].split(":");
              const [endH, endM] = times[1].split(":");

              const startDate = new Date(eventDate);
              startDate.setHours(parseInt(startH), parseInt(startM), 0);

              const endDate = new Date(eventDate);
              endDate.setHours(parseInt(endH), parseInt(endM), 0);

              events.push({
                title: c.matiere,
                start: startDate,
                end: endDate,
                extendedProps: {
                  filiere: c.filiere,
                  annee: c.annee,
                  salle: c.salle,
                },
                backgroundColor: "#059669",
                borderColor: "#047857",
              });
            }
          });
          successCallback(events);
        } catch (e) {
          console.error(e);
          failureCallback(e);
        }
      },
      eventContent: function (arg) {
        return {
          html: `
            <div class="p-1 overflow-hidden h-full">
              <div class="font-bold text-xs truncate">${arg.event.title}</div>
              <div class="text-[9px] flex gap-1 mt-1">
                <span class="bg-white/20 px-1 rounded truncate">${arg.event.extendedProps.filiere}</span>
                <span class="bg-white/20 px-1 rounded">${arg.event.extendedProps.annee}</span>
              </div>
              <div class="text-[10px] opacity-90 truncate mt-1"><i class="fas fa-door-open mr-1"></i>${arg.event.extendedProps.salle}</div>
            </div>
          `,
        };
      },
    });
    calendar.render();

    refreshBtn?.addEventListener("click", function () {
      calendar.refetchEvents();
    });
  });
</script>

{% endblock %}
