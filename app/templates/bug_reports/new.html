{% extends "base.html" %}
{% block title %}Nouveau rapport de bug - DEFITECH{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50/20 to-slate-50 py-6 sm:py-8 lg:py-12">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- En-tête avec navigation -->
    <div class="mb-6 sm:mb-8">
      <a href="{{ url_for('bug_reports.list_bug_reports') }}"
        class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-800 mb-4 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>
        Retour à la liste
      </a>

      <div class="flex flex-col space-y-2">
        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 flex items-center">
          <span
            class="flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-yellow-100 text-yellow-600 mr-3 sm:mr-4">
            <i class="fas fa-bug text-lg sm:text-xl"></i>
          </span>
          Nouveau rapport de bug
        </h1>
        <p class="text-sm sm:text-base text-gray-600 ml-0 lg:ml-16">
          Aidez-nous à améliorer la plateforme en signalant les problèmes rencontrés
        </p>
      </div>
    </div>

    <!-- Formulaire principal -->
    <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
      <div class="bg-gradient-to-r from-gray-50 to-white px-4 sm:px-6 py-5 border-b border-gray-200">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-900">
          <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>
          Détails du bug
        </h2>
        <p class="mt-1 text-sm text-gray-600">
          Remplissez tous les champs pour nous aider à comprendre et résoudre le problème rapidement
        </p>
      </div>

      <form method="POST" enctype="multipart/form-data" class="divide-y divide-gray-100">
        {{ form.hidden_tag() }}

        <!-- Titre -->
        <div class="px-4 sm:px-6 py-5 space-y-3">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.title.label.text }}
            <span class="text-red-500">*</span>
          </label>
          {{ form.title(class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-2
          focus:ring-blue-500/20 sm:text-sm transition-all",
          placeholder="Ex: Erreur 500 sur la page de connexion") }}
          {% if form.title.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.title.errors[0] }}
          </p>
          {% endif %}
          <p class="text-xs text-gray-500 flex items-start">
            <i class="fas fa-info-circle mr-2 mt-0.5 text-blue-500"></i>
            <span>Donnez un titre clair et concis au problème</span>
          </p>
        </div>

        <!-- Description -->
        <div class="px-4 sm:px-6 py-5 space-y-3 bg-gray-50/50">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.description.label.text }}
            <span class="text-red-500">*</span>
          </label>
          {{ form.description(class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500
          focus:ring-2 focus:ring-blue-500/20 sm:text-sm transition-all min-h-[120px]",
          placeholder="Décrivez le problème en détail...") }}
          {% if form.description.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.description.errors[0] }}
          </p>
          {% endif %}
          <p class="text-xs text-gray-500 flex items-start">
            <i class="fas fa-info-circle mr-2 mt-0.5 text-blue-500"></i>
            <span>Décrivez ce qui ne fonctionne pas comme prévu et l'impact sur votre utilisation</span>
          </p>
        </div>

        <!-- Étapes pour reproduire -->
        <div class="px-4 sm:px-6 py-5 space-y-3">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.steps_to_reproduce.label.text }}
            <span class="text-red-500">*</span>
          </label>
          {{ form.steps_to_reproduce(class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500
          focus:ring-2 focus:ring-blue-500/20 sm:text-sm transition-all min-h-[120px]",
          placeholder="1. Aller sur la page...\n2. Cliquer sur...\n3. Observer que...") }}
          {% if form.steps_to_reproduce.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.steps_to_reproduce.errors[0] }}
          </p>
          {% endif %}
          <p class="text-xs text-gray-500 flex items-start">
            <i class="fas fa-info-circle mr-2 mt-0.5 text-blue-500"></i>
            <span>Listez les étapes précises pour reproduire le problème (numérotez-les)</span>
          </p>
        </div>

        <!-- Priorité avec guide visuel -->
        <div class="px-4 sm:px-6 py-5 space-y-4 bg-gray-50/50">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.priority.label.text }}
            <span class="text-red-500">*</span>
          </label>
          {{ form.priority(class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-2
          focus:ring-blue-500/20 sm:text-sm transition-all") }}
          {% if form.priority.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.priority.errors[0] }}
          </p>
          {% endif %}

          <!-- Guide de priorité -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 pt-2">
            <div
              class="group p-4 border-2 border-green-200 rounded-xl bg-white hover:bg-green-50 transition-all cursor-pointer">
              <div class="flex items-center mb-2">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-green-100 text-green-600 mr-3">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div>
                  <p class="text-sm font-semibold text-gray-900">Faible</p>
                </div>
              </div>
              <p class="text-xs text-gray-600">Problème mineur sans impact majeur</p>
            </div>

            <div
              class="group p-4 border-2 border-blue-200 rounded-xl bg-white hover:bg-blue-50 transition-all cursor-pointer">
              <div class="flex items-center mb-2">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 text-blue-600 mr-3">
                  <i class="fas fa-info-circle"></i>
                </div>
                <div>
                  <p class="text-sm font-semibold text-gray-900">Moyen</p>
                </div>
              </div>
              <p class="text-xs text-gray-600">Problème gênant mais contournable</p>
            </div>

            <div
              class="group p-4 border-2 border-orange-200 rounded-xl bg-white hover:bg-orange-50 transition-all cursor-pointer">
              <div class="flex items-center mb-2">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-orange-100 text-orange-600 mr-3">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div>
                  <p class="text-sm font-semibold text-gray-900">Élevé</p>
                </div>
              </div>
              <p class="text-xs text-gray-600">Bloque une fonctionnalité importante</p>
            </div>

            <div
              class="group p-4 border-2 border-red-200 rounded-xl bg-white hover:bg-red-50 transition-all cursor-pointer">
              <div class="flex items-center mb-2">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-red-100 text-red-600 mr-3">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <div>
                  <p class="text-sm font-semibold text-gray-900">Critique</p>
                </div>
              </div>
              <p class="text-xs text-gray-600">Bloque complètement l'utilisation</p>
            </div>
          </div>
        </div>

        <!-- Zone de capture d'écran -->
        <div class="px-4 sm:px-6 py-5 space-y-3">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.screenshot.label.text }}
            <span class="text-gray-500 text-xs font-normal ml-1">(optionnel)</span>
          </label>

          <div
            class="mt-1 flex justify-center px-6 pt-8 pb-8 border-2 border-gray-300 border-dashed rounded-xl hover:border-blue-400 transition-all bg-gray-50/50 hover:bg-blue-50/50"
            id="drop-area">
            <div class="space-y-2 text-center">
              <svg class="mx-auto h-14 w-14 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"
                aria-hidden="true">
                <path
                  d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <div class="flex flex-col sm:flex-row text-sm text-gray-600 justify-center items-center">
                <label for="screenshot"
                  class="relative cursor-pointer rounded-md font-semibold text-blue-600 hover:text-blue-700 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500 transition-colors">
                  <span>Télécharger un fichier</span>
                  {{ form.screenshot(class="sr-only") }}
                </label>
                <p class="pl-1">ou glisser-déposer</p>
              </div>
              <p class="text-xs text-gray-500">PNG, JPG, GIF jusqu'à 5MB</p>
            </div>
          </div>

          {% if form.screenshot.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.screenshot.errors[0] }}
          </p>
          {% endif %}
          <p class="text-xs text-gray-500 flex items-start">
            <i class="fas fa-info-circle mr-2 mt-0.5 text-blue-500"></i>
            <span>Une capture d'écran aide à identifier le problème plus rapidement</span>
          </p>
        </div>

        <!-- Boutons d'action -->
        <div
          class="px-4 sm:px-6 py-4 bg-gradient-to-r from-gray-50 to-white flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
          <a href="{{ url_for('bug_reports.list_bug_reports') }}"
            class="inline-flex justify-center items-center px-5 py-2.5 border border-gray-300 shadow-sm text-sm font-medium rounded-xl text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all">
            <i class="fas fa-times mr-2"></i>
            Annuler
          </a>
          <button type="submit"
            class="inline-flex justify-center items-center px-6 py-2.5 border border-transparent shadow-lg text-sm font-medium rounded-xl text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform hover:scale-105">
            <i class="fas fa-paper-plane mr-2"></i>
            Soumettre le rapport
          </button>
        </div>
      </form>
    </div>

    <!-- Conseils améliorés -->
    <div class="mt-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-5 sm:p-6 border border-blue-100">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <div class="flex items-center justify-center h-10 w-10 rounded-xl bg-blue-100 text-blue-600">
            <i class="fas fa-lightbulb text-lg"></i>
          </div>
        </div>
        <div class="ml-4 flex-1">
          <h3 class="text-base sm:text-lg font-semibold text-blue-900 mb-3">
            Conseils pour un rapport efficace
          </h3>
          <ul class="space-y-2.5 text-sm text-blue-800">
            <li class="flex items-start">
              <i class="fas fa-check-circle mt-0.5 mr-3 text-blue-600 flex-shrink-0"></i>
              <span><strong>Soyez précis :</strong> Décrivez exactement ce qui ne fonctionne pas</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle mt-0.5 mr-3 text-blue-600 flex-shrink-0"></i>
              <span><strong>Étapes détaillées :</strong> Listez toutes les actions pour reproduire le bug</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle mt-0.5 mr-3 text-blue-600 flex-shrink-0"></i>
              <span><strong>Capture d'écran :</strong> Une image vaut mille mots pour visualiser le problème</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle mt-0.5 mr-3 text-blue-600 flex-shrink-0"></i>
              <span><strong>Environnement :</strong> Mentionnez votre navigateur et système d'exploitation</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Aperçu d'image amélioré
  const screenshotInput = document.getElementById('screenshot');
  const dropArea = document.getElementById('drop-area');

  screenshotInput.addEventListener('change', handleFileSelect);

  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        alert('Le fichier est trop volumineux. Maximum 5MB.');
        screenshotInput.value = '';
        return;
      }

      const reader = new FileReader();
      const container = dropArea.querySelector('.space-y-2');

      reader.onload = function (e) {
        const oldPreview = dropArea.querySelector('.image-preview');
        if (oldPreview) oldPreview.remove();

        const preview = document.createElement('div');
        preview.className = 'image-preview mt-4';
        preview.innerHTML = `
          <div class="relative inline-block group">
            <img src="${e.target.result}" alt="Aperçu" 
                 class="max-h-48 w-auto rounded-xl border-2 border-gray-200 shadow-lg">
            <button type="button" 
                    class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-2 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 shadow-lg transition-all transform hover:scale-110"
                    onclick="removePreview()">
              <i class="fas fa-times text-sm"></i>
            </button>
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all rounded-xl"></div>
          </div>
        `;

        container.appendChild(preview);
        container.querySelectorAll('svg, .flex, p.text-xs').forEach(el => el.style.display = 'none');
      };

      reader.readAsDataURL(file);
    }
  }

  function removePreview() {
    screenshotInput.value = '';
    const preview = dropArea.querySelector('.image-preview');
    if (preview) preview.remove();

    const container = dropArea.querySelector('.space-y-2');
    container.querySelectorAll('svg, .flex, p.text-xs').forEach(el => el.style.display = '');
  }

  // Gestion du drag & drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, e => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  ['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => {
      dropArea.classList.add('border-blue-500', 'bg-blue-100');
    });
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => {
      dropArea.classList.remove('border-blue-500', 'bg-blue-100');
    });
  });

  dropArea.addEventListener('drop', e => {
    const files = e.dataTransfer.files;
    if (files.length) {
      screenshotInput.files = files;
      handleFileSelect({ target: { files } });
    }
  });
</script>
{% endblock %}