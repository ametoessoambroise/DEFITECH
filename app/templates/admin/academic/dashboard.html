{% extends "admin/base.html" %} {% block title %}Gestion Académique - Clôture
Annuelle | DEFITECH{% endblock %} {% block content %}
<div class="min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
    <!-- Header -->
    <div
      class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center"
    >
      <div>
        <h1
          class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600"
        >
          Clôture Annuelle
        </h1>
        <p class="text-gray-600">
          Visualisez les résultats prévisionnels et validez le passage en année
          supérieure.
        </p>
      </div>

      <form
        action="{{ url_for('admin_academic.cloturer_annee') }}"
        method="POST"
        onsubmit="return confirm('ATTENTION : Cette action est irréversible. Elle va geler les notes et faire passer les étudiants. Êtes-vous sûr ?');"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button
          type="submit"
          class="mt-4 sm:mt-0 px-6 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 transition-all flex items-center"
        >
          <i class="fas fa-lock mr-2"></i> CLÔTURER L'ANNÉE OFFICIELLEMENT
        </button>
      </form>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
        <p class="text-sm font-bold text-gray-500 uppercase">Total Étudiants</p>
        <p class="text-3xl font-black text-gray-900">
          {{ students_data|length }}
        </p>
      </div>
      <div
        class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-green-500"
      >
        <p class="text-sm font-bold text-gray-500 uppercase">
          Admis (Prévision)
        </p>
        <p class="text-3xl font-black text-green-600">
          {{ students_data | selectattr('decision', 'equalto', 'ADMIS') | list |
          length }}
        </p>
      </div>
      <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-red-500">
        <p class="text-sm font-bold text-gray-500 uppercase">
          En Danger / Redoublement
        </p>
        <p class="text-3xl font-black text-red-600">
          {{ students_data | selectattr('decision', 'equalto', 'REDOUBLEMENT') |
          list | length }}
        </p>
      </div>
    </div>

    <!-- Data Table -->
    <div
      class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200"
    >
      <div class="overflow-x-auto">
        <table class="w-full whitespace-nowrap">
          <thead>
            <tr
              class="bg-gray-50 border-b border-gray-200 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
            >
              <th class="px-6 py-4">Étudiant</th>
              <th class="px-6 py-4">Filière / Année</th>
              <th class="px-6 py-4 text-center">Score Global (Crédits)</th>
              <th class="px-6 py-4 text-center">Crédits Acquis</th>
              <th class="px-6 py-4 text-center">Décision</th>
              <th class="px-6 py-4 text-center">Détails</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for item in students_data %}
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-6 py-4">
                <div class="flex items-center">
                  <div class="font-bold text-gray-900">
                    {{ item.student.user.nom }} {{ item.student.user.prenom }}
                  </div>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900 font-medium">
                  {{ item.student.filiere }}
                </div>
                <div class="text-xs text-gray-500">
                  {{ item.student.annee }}
                </div>
              </td>
              <td class="px-6 py-4 text-center">
                <span
                  class="px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800"
                >
                  {{ item.moyenne_generale }}
                </span>
              </td>
              <td class="px-6 py-4 text-center">
                <div
                  class="text-sm font-bold {{ 'text-green-600' if item.credits_total >= 45 else 'text-red-600' }}"
                >
                  {{ item.credits_total }} / {{ item.credits_max }}
                </div>
              </td>
              <td class="px-6 py-4 text-center">
                {% if item.decision == 'ADMIS' %}
                <span
                  class="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-200"
                >
                  ADMIS
                </span>
                {% else %}
                <span
                  class="px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800 border border-red-200"
                >
                  REDOUBLEMENT
                </span>
                {% endif %}
              </td>
              <td class="px-6 py-4 text-center">
                <a
                  href="{{ url_for('admin_academic.download_transcript', student_id=item.student.id) }}"
                  class="text-indigo-600 hover:text-indigo-900 mr-3"
                  title="Télécharger Relevé"
                >
                  <i class="fas fa-file-pdf"></i>
                </a>
                <button
                  onclick="toggleDetails('details-{{ item.student.id }}')"
                  class="text-gray-500 hover:text-blue-600 transition-colors"
                  title="Voir Détails"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
            <!-- Hidden Row for Details -->
            <tr id="details-{{ item.student.id }}" class="hidden bg-gray-50">
              <td colspan="6" class="px-6 py-4">
                <div
                  class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                >
                  {% for detail in item.details %}
                  <div
                    class="p-3 bg-white rounded-lg border {{ 'border-green-200' if detail.stats.is_validated else 'border-red-200' }} shadow-sm"
                  >
                    <p class="font-bold text-sm truncate">
                      {{ detail.matiere.nom }}
                    </p>
                    <div class="flex justify-between mt-2 text-xs">
                      <span>Moy: {{ detail.stats.moyenne }}/20</span>
                      <span class="font-bold"
                        >{{ detail.stats.credits_obtenus }} Crédits</span
                      >
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleDetails(id) {
    const el = document.getElementById(id);
    if (el.classList.contains("hidden")) {
      el.classList.remove("hidden");
    } else {
      el.classList.add("hidden");
    }
  }
</script>
{% endblock %}
