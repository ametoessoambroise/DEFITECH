{% extends "base.html" %} {% block title %}Ajouter une ressource - DEFITECH{%
endblock %} {% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white shadow rounded-lg">
      <!-- Header -->
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">
              Ajouter une ressource
            </h1>
            <p class="mt-1 text-sm text-gray-600">
              Partagez des documents avec vos étudiants
            </p>
          </div>
          <a
            href="{{ url_for('resources.index') }}"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times text-xl"></i>
          </a>
        </div>
      </div>

      <!-- Formulaire -->
      <form
        method="POST"
        enctype="multipart/form-data"
        class="px-6 py-6 space-y-6"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <!-- Titre -->
        <div>
          <label
            for="titre"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            Titre de la ressource <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="titre"
            id="titre"
            required
            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            placeholder="Ex: Cours de Mathématiques - Chapitre 1"
          />
          <p class="mt-1 text-sm text-gray-500">
            Donnez un titre descriptif à votre ressource
          </p>
        </div>

        <!-- Description -->
        <div>
          <label
            for="description"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            Description
          </label>
          <textarea
            name="description"
            id="description"
            rows="3"
            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            placeholder="Décrivez brièvement le contenu de cette ressource..."
          ></textarea>
          <p class="mt-1 text-sm text-gray-500">
            Description optionnelle pour aider les étudiants à comprendre le
            contenu
          </p>
        </div>

        <!-- Type de ressource et fichier -->
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <!-- Type de ressource -->
          <div>
            <label
              for="type_ressource"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Type de ressource <span class="text-red-500">*</span>
            </label>
            <select
              name="type_ressource"
              id="type_ressource"
              required
              class="block w-full px-3 py-2 border border-gray-300 text-black rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Sélectionnez un type</option>
              {% for type in resource_types %}
              <option value="{{ type }}">{{ type|title }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Fichier -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Fichier <span class="text-red-500">*</span>
            </label>

            <!-- Hidden inputs for Cloudinary data -->
            <input type="hidden" name="file_url" id="file_url" />
            <input type="hidden" name="file_type" id="file_type" />
            <input type="hidden" name="file_size" id="file_size" />
            <input type="hidden" name="file_format" id="file_format" />
            <input
              type="hidden"
              name="original_filename"
              id="original_filename"
            />

            <div
              class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md"
            >
              <div class="space-y-1 text-center">
                <i
                  class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2"
                ></i>
                <div class="flex text-sm text-gray-600 justify-center">
                  <label
                    for="fichier_input"
                    class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500"
                  >
                    <span>Cliquez pour sélectionner</span>
                    <input
                      id="fichier_input"
                      type="file"
                      multiple
                      class="sr-only"
                      accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.zip,.rar,.7z,.jpg,.jpeg,.png"
                    />
                  </label>
                  <p class="pl-1">ou glissez-déposez</p>
                </div>
                <p class="text-xs text-gray-500">
                  PDF, DOC, PPT, XLS, TXT, ZIP jusqu'à 50MB
                </p>
                <div
                  id="upload_feedback"
                  class="mt-2 text-sm text-blue-600 font-medium"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Script de gestion de l'upload et validation -->
        <script>
          document.addEventListener("DOMContentLoaded", () => {
            const fileInput = document.getElementById("fichier_input");
            const feedback = document.getElementById("upload_feedback");
            const matiereSelect = document.getElementById("matiere_id");
            const filiereSelect = document.getElementById("filiere");
            const submitBtn = document.querySelector('button[type="submit"]');

            const CLOUD_NAME = "dmokvhpjt";
            const UPLOAD_PRESET = "documents_upload";

            // Types autorisés
            const allowedTypes = [
              "application/pdf",
              "application/msword",
              "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
              "application/vnd.ms-powerpoint",
              "application/vnd.openxmlformats-officedocument.presentationml.presentation",
              "application/vnd.ms-excel",
              "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
              "text/plain",
              "application/zip",
              "application/x-rar-compressed",
              "application/x-7z-compressed",
              "image/jpeg",
              "image/png",
            ];
            const maxSize = 50 * 1024 * 1024; // 50MB

            if (fileInput) {
              fileInput.addEventListener("change", async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // 1. Validation locale et population du titre
                if (file) {
                  const titreInput = document.getElementById("titre");
                  if (
                    titreInput &&
                    (!titreInput.value || titreInput.value.trim() === "")
                  ) {
                    const fileNameWithoutExt = file.name.replace(
                      /\.[^/.]+$/,
                      ""
                    );
                    titreInput.value = fileNameWithoutExt;
                  }
                }

                if (file.size > maxSize) {
                  showNotification("Le fichier dépasse 50MB.", "erreur");
                  fileInput.value = "";
                  return;
                }

                if (
                  !allowedTypes.includes(file.type) &&
                  !file.name.match(/\.(zip|rar|7z)$/i)
                ) {
                  // Fallback check for archives if MIME type is generic
                  if (
                    !file.name.match(
                      /\.(pdf|doc|docx|ppt|pptx|xls|xlsx|txt|jpg|jpeg|png)$/i
                    )
                  ) {
                    showNotification(
                      "Format de fichier non supporté.",
                      "erreur"
                    );
                    fileInput.value = "";
                    return;
                  }
                }

                // 2. Upload Cloudinary
                try {
                  submitBtn.disabled = true;
                  submitBtn.innerHTML =
                    '<i class="fas fa-spinner fa-spin mr-2"></i> Upload en cours...';

                  feedback.innerHTML =
                    '<i class="fas fa-spinner fa-spin"></i> Transfert vers le cloud...';
                  feedback.className = "mt-2 text-sm text-blue-600 font-medium";

                  const formData = new FormData();
                  formData.append("file", file);
                  formData.append("upload_preset", UPLOAD_PRESET);

                  const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,
                    {
                      method: "POST",
                      body: formData,
                    }
                  );

                  if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(
                      errorDetails.error?.message || "Erreur serveur Cloudinary"
                    );
                  }

                  const data = await response.json();

                  // Remplissage des champs cachés
                  document.getElementById("file_url").value = data.secure_url;
                  document.getElementById("file_type").value =
                    data.resource_type;
                  document.getElementById("file_size").value = data.bytes;
                  document.getElementById("file_format").value =
                    data.format || file.name.split(".").pop();
                  document.getElementById("original_filename").value =
                    file.name;

                  feedback.innerHTML =
                    '<i class="fas fa-check"></i> Fichier prêt';
                  feedback.className =
                    "mt-2 text-sm text-green-600 font-medium";
                } catch (error) {
                  console.error("Cloudinary Error:", error);
                  showNotification(
                    "Échec de l'upload: " + error.message,
                    "erreur"
                  );
                  feedback.innerHTML =
                    '<i class="fas fa-times"></i> Échec de l\'upload';
                  feedback.className = "mt-2 text-sm text-red-600 font-medium";
                  fileInput.value = "";
                } finally {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML =
                    '<i class="fas fa-upload mr-2"></i> Uploader la ressource';
                }
              });
            }

            function showNotification(message, type = "info") {
              const notification = document.createElement("div");
              notification.className =
                "fixed top-4 right-4 z-[10001] px-6 py-4 rounded-lg shadow-xl text-white transform transition-all duration-500 flex items-center";

              const colors = {
                success: "bg-green-600",
                erreur: "bg-red-600",
                warning: "bg-yellow-500",
                info: "bg-blue-600",
              };

              notification.classList.add(colors[type] || colors.info);
              notification.innerHTML = `<i class="fas ${
                type === "success"
                  ? "fa-check-circle"
                  : "fa-exclamation-triangle"
              } mr-3"></i> <span>${message}</span>`;

              document.body.appendChild(notification);
              setTimeout(() => {
                notification.style.opacity = "0";
                setTimeout(() => notification.remove(), 500);
              }, 4000);
            }
          });
        </script>
        <!-- Cible (filière et année) -->
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <!-- Filière -->
          <div>
            <label
              for="filiere"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Filière <span class="text-red-500">*</span>
            </label>
            <select
              name="filiere"
              id="filiere"
              required
              class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Sélectionnez une filière</option>
              {% for filiere in filieres %}
              <option value="{{ filiere }}">{{ filiere }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Année -->
          <div>
            <label
              for="annee"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Année <span class="text-red-500">*</span>
            </label>
            <select
              name="annee"
              id="annee"
              required
              class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Sélectionnez une année</option>
              {% for annee in annees %}
              <option value="{{ annee }}">{{ annee }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Matière (optionnel) -->
        <div>
          <label
            for="matiere_id"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            Matière (optionnel)
          </label>
          <select
            name="matiere_id"
            id="matiere_id"
            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">Toutes les matières</option>
            {% for matiere in matieres %}
            <option value="{{ matiere.id }}">{{ matiere.nom }}</option>
            {% endfor %}
          </select>
          <p class="mt-1 text-sm text-gray-500">
            Associez cette ressource à une matière spécifique si applicable
          </p>
        </div>

        <!-- Informations sur les formats acceptés -->
        <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-info-circle text-blue-400"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-blue-800">
                Formats de fichiers acceptés
              </h3>
              <div class="mt-2 text-sm text-blue-700">
                <p>Documents : PDF, DOC, DOCX, TXT</p>
                <p>Présentations : PPT, PPTX</p>
                <p>Tableurs : XLS, XLSX</p>
                <p>Archives : ZIP, RAR, 7Z</p>
                <p>Images : JPG, JPEG, PNG</p>
                <p class="mt-2 font-medium">Taille maximale : 50 MB</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Boutons d'action -->
        <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
          <a
            href="{{ url_for('resources.index') }}"
            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Annuler
          </a>
          <button
            type="submit"
            class="px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            <i class="fas fa-upload mr-2"></i>
            Uploader la ressource
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
