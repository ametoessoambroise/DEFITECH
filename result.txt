# Erreur

Erreur lors de l'enregistrement : (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely) (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "_salle_jour_creneau_uc" DETAIL: Key (salle, jour, heure_debut, heure_fin)=(Ã€ dÃ©finir, Lundi, 07:00:00, 10:00:00) already exists. [SQL: UPDATE emploi_temps SET enseignant_id=%(enseignant_id)s, matiere_id=%(matiere_id)s, salle=%(salle)s WHERE emploi_temps.id = %(emploi_temps_id)s] [parameters: {'enseignant_id': 5, 'matiere_id': '12', 'salle': 'Ã€ dÃ©finir', 'emploi_temps_id': 3}] (Background on this error at: https://sqlalche.me/e/20/gkpj)

## SOLUTION  1ï¸âƒ£ Clarifier la rÃ¨gle mÃ©tier (fondation)

ğŸ‘‰ **RÃ¨gle claire Ã  poser :**

> Un enseignant **ne peut pas Ãªtre affectÃ© Ã  deux cours qui se chevauchent**, quelle que soit la filiÃ¨re, lâ€™annÃ©e ou la matiÃ¨re.

Cette rÃ¨gle doit Ãªtre :

* âœ… **visible cÃ´tÃ© UX**
* âœ… **contrÃ´lÃ©e cÃ´tÃ© backend**
* âŒ **jamais laissÃ©e uniquement Ã  la base de donnÃ©es**

---

## 2ï¸âƒ£ AmÃ©lioration UX (ce que voit lâ€™utilisateur)

### âŒ Ce qui se passe aujourdâ€™hui

* Lâ€™utilisateur choisit une matiÃ¨re
* Il clique sur enregistrer
* ğŸ’¥ Erreur SQL obscure (UniqueViolation)
  â¡ï¸ Mauvaise UX

---

### âœ… UX amÃ©liorÃ©e (progressive et intelligente)

#### ğŸ”¹ Option A â€“ Masquer automatiquement les matiÃ¨res impossibles (idÃ©al UX)

Quand lâ€™utilisateur :

* choisit un **crÃ©neau (jour + heure dÃ©but + heure fin)**
* choisit un **enseignant**

â¡ï¸ **La liste des matiÃ¨res est filtrÃ©e automatiquement**

ğŸ’¡ RÃ¨gle :

* Si lâ€™enseignant est dÃ©jÃ  occupÃ© sur ce crÃ©neau
* âŒ On **nâ€™affiche pas** les matiÃ¨res liÃ©es Ã  cet enseignant

ğŸ“Œ Avantages :

* ZÃ©ro frustration
* Impossible de faire une erreur
* UX fluide

ğŸ“Œ InconvÃ©nient :

* Lâ€™utilisateur peut ne pas comprendre *pourquoi* une matiÃ¨re nâ€™apparaÃ®t pas

â¡ï¸ **Solution** : afficher un indicateur ğŸ‘‡

> â„¹ï¸ *Certaines matiÃ¨res sont masquÃ©es car lâ€™enseignant est dÃ©jÃ  occupÃ© Ã  ce crÃ©neau.*

---

#### ğŸ”¹ Option B â€“ Afficher mais bloquer (plus explicite)

* On affiche toutes les matiÃ¨res
* Mais celles impossibles sont :

  * grisÃ©es
  * non sÃ©lectionnables

Avec tooltip :

> âŒ Enseignant dÃ©jÃ  affectÃ© Ã  un autre cours de 07:00 Ã  10:00

ğŸ“Œ Avantage :

* TrÃ¨s explicite
* PÃ©dagogique

ğŸ“Œ Recommandation :
ğŸ‘‰ **Option B en back-office**, Option A en interface simple

---

## 3ï¸âƒ£ Validation backend (indispensable)

MÃªme avec une bonne UX :
âš ï¸ **le backend doit bloquer**

### âœ… Avant toute sauvegarde :

```python
def enseignant_est_disponible(
    session,
    enseignant_id,
    jour,
    heure_debut,
    heure_fin,
    emploi_temps_id=None
):
    q = session.query(EmploiTemps).filter(
        EmploiTemps.enseignant_id == enseignant_id,
        EmploiTemps.jour == jour,
        EmploiTemps.heure_debut < heure_fin,
        EmploiTemps.heure_fin > heure_debut
    )

    # pour une modification (Ã©viter faux positif)
    if emploi_temps_id:
        q = q.filter(EmploiTemps.id != emploi_temps_id)

    return not session.query(q.exists()).scalar()
```

Puis :

```python
if not enseignant_est_disponible(...):
    raise ValidationError(
        "L'enseignant est dÃ©jÃ  occupÃ© sur ce crÃ©neau horaire."
    )
```

ğŸ¯ RÃ©sultat :

* Message clair
* Pas dâ€™erreur SQL exposÃ©e
* Logique mÃ©tier respectÃ©e

---

## 4ï¸âƒ£ Gestion spÃ©cifique de ton erreur actuelle (UniqueViolation)

Ton erreur :

```sql
duplicate key value violates unique constraint "_salle_jour_creneau_uc"
```

ğŸ‘‰ ProblÃ¨me :

* Tu mets `salle = "Ã€ dÃ©finir"`
* Donc plusieurs cours ont :

  ```
  (salle, jour, heure_debut, heure_fin)
  ```

  identiques

### âœ… AmÃ©lioration proposÃ©e

#### ğŸ”¹ Option recommandÃ©e

* Autoriser `salle = NULL`
* Mettre la contrainte UNIQUE **partielle** :

```sql
CREATE UNIQUE INDEX unique_salle_creneau
ON emploi_temps (salle, jour, heure_debut, heure_fin)
WHERE salle IS NOT NULL;
```

â¡ï¸ RÃ©sultat :

* Plusieurs cours peuvent Ãªtre "Ã€ dÃ©finir"
* Le conflit nâ€™apparaÃ®t que quand une vraie salle est affectÃ©e

---

## 5ï¸âƒ£ SynthÃ¨se â€“ Version amÃ©liorÃ©e de ton idÃ©e ğŸ’¡

> Lors de la planification dâ€™un cours, le systÃ¨me doit empÃªcher toute affectation dâ€™un enseignant sur un crÃ©neau oÃ¹ il est dÃ©jÃ  occupÃ©.
> Cette contrainte est gÃ©rÃ©e **Ã  trois niveaux** :
>
> 1. **UX** : les matiÃ¨res impossibles sont masquÃ©es ou dÃ©sactivÃ©es selon le contexte.
> 2. **Backend** : une validation explicite empÃªche toute sauvegarde invalide.
> 3. **Base de donnÃ©es** : les contraintes garantissent lâ€™intÃ©gritÃ© sans exposer dâ€™erreurs techniques Ã  lâ€™utilisateur.



