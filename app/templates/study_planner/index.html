{% extends "base.html" %} {% block title %}Planificateur d'Études - DEFITECH{%
endblock %} {% block content %}

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes pulse-glow {
    0%,
    100% {
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
    }
    50% {
      box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
    }
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.6s ease-out forwards;
  }

  .animate-slide-in-right {
    animation: slideInRight 0.5s ease-out forwards;
  }

  .animate-delay-100 {
    animation-delay: 0.1s;
  }
  .animate-delay-200 {
    animation-delay: 0.2s;
  }
  .animate-delay-300 {
    animation-delay: 0.3s;
  }

  .card-hover {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card-hover:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
      0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .btn-primary {
    transition: all 0.2s ease-in-out;
  }

  .btn-primary:active {
    transform: scale(0.98);
  }
</style>

<div
  class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-50 py-4 sm:py-6 lg:py-8 text-black"
>
  <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8">
    <!-- Header - Mobile Optimized -->
    <div class="mb-4 sm:mb-6 lg:mb-8 animate-fade-in-up">
      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4"
      >
        <div class="flex-1 min-w-0">
          <h1
            class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 flex items-center truncate"
          >
            <i
              class="fas fa-calendar-alt text-blue-600 mr-2 sm:mr-3 text-xl sm:text-2xl lg:text-3xl flex-shrink-0"
            ></i>
            <span class="truncate">Mon Planificateur</span>
          </h1>
          <p class="mt-1 sm:mt-2 text-xs sm:text-sm text-gray-600">
            Optimisez votre apprentissage
          </p>
        </div>

        <div class="flex gap-2 sm:gap-3">
          <button
            onclick="refreshDashboard()"
            class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all duration-200 text-sm sm:text-base active:scale-95"
            aria-label="Actualiser le tableau de bord"
          >
            <i class="fas fa-sync-alt sm:mr-2"></i>
            <span class="hidden sm:inline">Actualiser</span>
          </button>
          <button
            onclick="openGeneratePlanModal()"
            class="flex-1 sm:flex-none px-4 sm:px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg btn-primary text-sm sm:text-base"
            aria-label="Générer un nouveau plan d'étude"
          >
            <i class="fas fa-magic mr-2"></i>
            <span class="hidden xs:inline">Générer</span>
            <span class="xs:hidden">Plan</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="hidden">
      <div class="flex flex-col items-center justify-center py-12 sm:py-20">
        <div
          class="animate-spin rounded-full h-12 w-12 sm:h-16 sm:w-16 border-b-2 border-blue-600 mb-4"
        ></div>
        <p class="text-sm text-gray-600">Chargement...</p>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-content">
      <!-- Overview Cards - Mobile Grid -->
      <div
        class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-4 sm:mb-6 lg:mb-8"
      >
        <!-- Moyenne Générale -->
        <div
          class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 text-white card-hover animate-fade-in-up"
        >
          <div class="flex items-center justify-between mb-2 sm:mb-4">
            <div class="bg-white/20 rounded-lg p-2 sm:p-3">
              <i class="fas fa-star text-lg sm:text-2xl"></i>
            </div>
            <span
              id="moyenne-badge"
              class="text-xs bg-white/20 px-2 py-1 rounded-full whitespace-nowrap"
              >--</span
            >
          </div>
          <h3 class="text-xs sm:text-sm font-medium opacity-90 truncate">
            Moyenne
          </h3>
          <p
            id="moyenne-generale"
            class="text-2xl sm:text-3xl font-bold mt-1 sm:mt-2"
          >
            --
          </p>
          <p id="nb-notes" class="text-xs mt-1 sm:mt-2 opacity-75">-- notes</p>
        </div>

        <!-- Taux de Présence -->
        <div
          class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 text-white card-hover animate-fade-in-up animate-delay-100"
        >
          <div class="flex items-center justify-between mb-2 sm:mb-4">
            <div class="bg-white/20 rounded-lg p-2 sm:p-3">
              <i class="fas fa-calendar-check text-lg sm:text-2xl"></i>
            </div>
            <span
              id="presence-status"
              class="text-xs bg-white/20 px-2 py-1 rounded-full whitespace-nowrap"
              >--</span
            >
          </div>
          <h3 class="text-xs sm:text-sm font-medium opacity-90 truncate">
            Présence
          </h3>
          <p
            id="taux-presence"
            class="text-2xl sm:text-3xl font-bold mt-1 sm:mt-2"
          >
            --%
          </p>
          <p class="text-xs mt-1 sm:mt-2 opacity-75">Assiduité</p>
        </div>

        <!-- Devoirs à Venir -->
        <div
          class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 text-white card-hover animate-fade-in-up animate-delay-200"
        >
          <div class="flex items-center justify-between mb-2 sm:mb-4">
            <div class="bg-white/20 rounded-lg p-2 sm:p-3">
              <i class="fas fa-clipboard-list text-lg sm:text-2xl"></i>
            </div>
            <span
              id="devoirs-urgents-badge"
              class="text-xs bg-red-500 px-2 py-1 rounded-full hidden animate-pulse"
              >!</span
            >
          </div>
          <h3 class="text-xs sm:text-sm font-medium opacity-90 truncate">
            Devoirs
          </h3>
          <p
            id="devoirs-a-venir"
            class="text-2xl sm:text-3xl font-bold mt-1 sm:mt-2"
          >
            --
          </p>
          <p id="devoirs-urgents" class="text-xs mt-1 sm:mt-2 opacity-75">
            -- urgents
          </p>
        </div>

        <!-- Temps d'Étude -->
        <div
          class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 text-white card-hover animate-fade-in-up animate-delay-300"
        >
          <div class="flex items-center justify-between mb-2 sm:mb-4">
            <div class="bg-white/20 rounded-lg p-2 sm:p-3">
              <i class="fas fa-clock text-lg sm:text-2xl"></i>
            </div>
            <span
              class="text-xs bg-white/20 px-2 py-1 rounded-full whitespace-nowrap"
              >par jour</span
            >
          </div>
          <h3 class="text-xs sm:text-sm font-medium opacity-90 truncate">
            Temps
          </h3>
          <p
            id="temps-etude"
            class="text-2xl sm:text-3xl font-bold mt-1 sm:mt-2"
          >
            -- min
          </p>
          <p class="text-xs mt-1 sm:mt-2 opacity-75 truncate">Quotidien</p>
        </div>
      </div>

      <!-- Main Content - Mobile Stack -->
      <div
        class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 mb-4 sm:mb-6 lg:mb-8"
      >
        <!-- Prochains Devoirs -->
        <div
          class="lg:col-span-2 bg-white rounded-xl sm:rounded-2xl shadow-lg border border-gray-200 overflow-hidden animate-slide-in-right"
        >
          <div
            class="bg-gradient-to-r from-blue-600 to-indigo-600 px-4 sm:px-6 py-3 sm:py-4"
          >
            <h3
              class="text-lg sm:text-xl font-bold text-white flex items-center"
            >
              <i class="fas fa-tasks mr-2"></i>
              <span class="truncate">Prochains Devoirs</span>
            </h3>
          </div>
          <div
            id="prochains-devoirs"
            class="p-4 sm:p-6 max-h-96 overflow-y-auto"
          >
            <div class="space-y-3 sm:space-y-4">
              <div class="animate-pulse">
                <div class="h-16 sm:h-20 bg-gray-200 rounded-lg"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Matières à Améliorer -->
        <div
          class="bg-white rounded-xl sm:rounded-2xl shadow-lg border border-gray-200 overflow-hidden animate-slide-in-right animate-delay-100"
        >
          <div
            class="bg-gradient-to-r from-red-500 to-red-600 px-4 sm:px-6 py-3 sm:py-4"
          >
            <h3
              class="text-lg sm:text-xl font-bold text-white flex items-center"
            >
              <i class="fas fa-exclamation-triangle mr-2"></i>
              <span class="truncate">À Améliorer</span>
            </h3>
          </div>
          <div
            id="matieres-faibles"
            class="p-4 sm:p-6 max-h-96 overflow-y-auto"
          >
            <div class="space-y-2 sm:space-y-3">
              <div class="animate-pulse">
                <div class="h-14 sm:h-16 bg-gray-200 rounded-lg"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recommandations IA -->
      <div
        class="bg-white rounded-xl sm:rounded-2xl shadow-lg border border-gray-200 overflow-hidden mb-4 sm:mb-6 lg:mb-8 animate-fade-in-up"
      >
        <div
          class="bg-gradient-to-r from-indigo-600 to-purple-600 px-4 sm:px-6 py-3 sm:py-4"
        >
          <h3 class="text-lg sm:text-xl font-bold text-white flex items-center">
            <i class="fas fa-robot mr-2"></i>
            <span class="truncate">Recommandations IA</span>
          </h3>
        </div>
        <div id="recommendations" class="p-4 sm:p-6">
          <div class="space-y-3 sm:space-y-4">
            <div class="animate-pulse">
              <div class="h-20 sm:h-24 bg-gray-200 rounded-lg"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- CTA Section - Mobile Optimized -->
      <div
        class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 rounded-xl sm:rounded-2xl shadow-2xl p-6 sm:p-8 text-center animate-fade-in-up"
      >
        <div class="max-w-3xl mx-auto">
          <i
            class="fas fa-magic text-4xl sm:text-5xl text-white mb-3 sm:mb-4"
          ></i>
          <h2
            class="text-xl sm:text-2xl lg:text-3xl font-bold text-white mb-3 sm:mb-4"
          >
            Prêt à optimiser votre apprentissage ?
          </h2>
          <p class="text-blue-100 mb-4 sm:mb-6 text-sm sm:text-base lg:text-lg">
            Générez un plan d'étude personnalisé basé sur vos performances.
          </p>
          <button
            onclick="openGeneratePlanModal()"
            class="w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-4 bg-white text-blue-600 rounded-xl font-semibold hover:bg-blue-50 transition-all transform hover:scale-105 active:scale-95 shadow-lg text-sm sm:text-base"
          >
            <i class="fas fa-calendar-plus mr-2"></i>
            Générer Mon Plan d'Étude
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Génération - Mobile responsive Screen -->
<div
  id="generate-plan-modal"
  class="hidden fixed overflow-y-auto inset-0 bg-black/50 z-50 items-end sm:items-center justify-center p-0 sm:p-4 border border-gray-50 backdrop-blur-sm"
>
  <div
    class="bg-white/80 rounded-3xl shadow-2xl pt-6 sm:max-w-2xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto transform transition-transform duration-300"
  >
    <div
      class="sticky top-0 bg-gradient-to-r from-blue-600 to-indigo-600 px-4 sm:px-6 pt-12 rounded-t-3xl sm:rounded-t-2xl z-10"
    >
      <div class="flex items-center justify-between">
        <h3 class="text-xl sm:text-2xl font-bold text-white flex items-center">
          <i class="fas fa-magic mr-2 sm:mr-3"></i>
          <span class="truncate">Générer un Plan</span>
        </h3>
        <button
          onclick="closeGeneratePlanModal()"
          class="text-white hover:text-blue-100 transition-colors p-2 -mr-2 active:scale-90"
          aria-label="Fermer"
        >
          <i class="fas fa-times text-xl sm:text-2xl"></i>
        </button>
      </div>
    </div>

    <form id="generate-plan-form" class="p-4 sm:p-6 space-y-4 sm:space-y-6">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-calendar-alt mr-1 text-blue-600"></i>
            Date de début
          </label>
          <input
            type="date"
            id="start-date"
            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm sm:text-base"
            required
          />
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-calendar-check mr-1 text-blue-600"></i>
            Date de fin
          </label>
          <input
            type="date"
            id="end-date"
            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm sm:text-base"
            required
          />
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-clock mr-1 text-blue-600"></i>
          Heures d'étude par jour
        </label>
        <div class="flex items-center gap-3 sm:gap-4">
          <input
            type="range"
            id="study-hours"
            min="1"
            max="8"
            value="3"
            class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
            oninput="updateStudyHoursLabel()"
          />
          <span
            id="study-hours-label"
            class="text-xl sm:text-2xl font-bold text-blue-600 w-12 sm:w-16 text-center"
            >3h</span
          >
        </div>
        <p class="text-xs text-gray-500 mt-2">
          Recommandé : 2-4 heures par jour
        </p>
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4">
        <div class="flex">
          <i
            class="fas fa-info-circle text-blue-600 mt-1 mr-2 sm:mr-3 flex-shrink-0"
          ></i>
          <div>
            <h4 class="font-semibold text-blue-900 mb-1 text-sm sm:text-base">
              Comment ça marche ?
            </h4>
            <p class="text-xs sm:text-sm text-blue-800">
              Notre algorithme analyse vos performances pour créer un plan
              optimisé avec la technique Pomodoro.
            </p>
          </div>
        </div>
      </div>

      <button
        type="submit"
        class="w-full px-4 sm:px-6 py-3 sm:py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg flex items-center justify-center btn-primary text-sm sm:text-base"
      >
        <i class="fas fa-magic mr-2"></i>
        Générer Mon Plan
      </button>
    </form>
  </div>
</div>

<script>
  // ==================== INITIALISATION ====================
  document.addEventListener("DOMContentLoaded", function () {
    loadDashboard();
    setDefaultDates();
    setupModalAnimations();
  });

  function setupModalAnimations() {
    const modal = document.getElementById("generate-plan-modal");
    modal.addEventListener("click", function (e) {
      if (e.target === modal) closeGeneratePlanModal();
    });
  }

  // ==================== CHARGEMENT DASHBOARD ====================
  async function loadDashboard() {
    showLoading(true);
    try {
      const response = await fetch("/study-planner/api/dashboard");
      const result = await response.json();
      if (result.success) {
        updateDashboard(result.data);
      } else {
        showError("Erreur lors du chargement des données");
      }
    } catch (error) {
      console.error("Error loading dashboard:", error);
      showError("Erreur de connexion");
    } finally {
      showLoading(false);
    }
  }

  function showLoading(isLoading) {
    const loadingState = document.getElementById("loading-state");
    const dashboardContent = document.getElementById("dashboard-content");
    if (isLoading) {
      loadingState.classList.remove("hidden");
      dashboardContent.classList.add("hidden");
    } else {
      loadingState.classList.add("hidden");
      dashboardContent.classList.remove("hidden");
    }
  }

  // ==================== UPDATE DASHBOARD ====================
  function updateDashboard(data) {
    const performance = data.performance || {};
    document.getElementById("moyenne-generale").textContent =
      performance.moyenne_generale || "0.00";
    document.getElementById("nb-notes").textContent = `${
      performance.nombre_notes || 0
    } notes`;
    document.getElementById("taux-presence").textContent = `${
      performance.taux_presence || 0
    }%`;

    const moyenne = parseFloat(performance.moyenne_generale || 0);
    const moyenneBadge = document.getElementById("moyenne-badge");
    if (moyenne >= 16) {
      moyenneBadge.textContent = "Excellent";
      moyenneBadge.className =
        "text-xs bg-green-500 px-2 py-1 rounded-full whitespace-nowrap";
    } else if (moyenne >= 14) {
      moyenneBadge.textContent = "Très bien";
      moyenneBadge.className =
        "text-xs bg-blue-500 px-2 py-1 rounded-full whitespace-nowrap";
    } else if (moyenne >= 12) {
      moyenneBadge.textContent = "Bien";
      moyenneBadge.className =
        "text-xs bg-yellow-500 px-2 py-1 rounded-full whitespace-nowrap";
    } else {
      moyenneBadge.textContent = "À améliorer";
      moyenneBadge.className =
        "text-xs bg-red-500 px-2 py-1 rounded-full whitespace-nowrap";
    }

    const devoirs = data.devoirs || {};
    document.getElementById("devoirs-a-venir").textContent =
      devoirs.a_venir || 0;
    document.getElementById("devoirs-urgents").textContent = `${
      devoirs.urgents || 0
    } urgents`;
    if (devoirs.urgents > 0) {
      document
        .getElementById("devoirs-urgents-badge")
        .classList.remove("hidden");
    }

    document.getElementById("temps-etude").textContent = `${
      data.temps_etude_recommande || 120
    } min`;

    renderProchainsDevoirs(data.prochains_devoirs || []);
    renderMatieiresFaibles(data.matieres_faibles || []);
    loadRecommendations();
  }

  // ==================== RENDER COMPONENTS ====================
  function renderProchainsDevoirs(devoirs) {
    const container = document.getElementById("prochains-devoirs");
    if (devoirs.length === 0) {
      container.innerHTML = `
        <div class="text-center py-6 sm:py-8">
          <i class="fas fa-check-circle text-green-500 text-4xl sm:text-5xl mb-2 sm:mb-3"></i>
          <p class="text-gray-600 text-sm sm:text-base">Aucun devoir à venir</p>
        </div>`;
      return;
    }

    container.innerHTML = devoirs
      .map((devoir) => {
        const urgentClass = devoir.urgent
          ? "border-red-500 bg-red-50"
          : "border-gray-200";
        const urgentBadge = devoir.urgent
          ? '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded-full animate-pulse">Urgent</span>'
          : "";
        return `
        <div class="border-l-4 ${urgentClass} rounded-lg p-3 sm:p-4 hover:shadow-md transition-all duration-200 card-hover">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1 flex-wrap">
                <h4 class="font-semibold text-gray-900 text-sm sm:text-base truncate">${
                  devoir.titre
                }</h4>
                ${urgentBadge}
              </div>
              <p class="text-xs sm:text-sm text-gray-600 truncate">${
                devoir.type
              }</p>
              <div class="flex flex-wrap items-center gap-2 sm:gap-4 mt-2 text-xs text-gray-500">
                <span class="flex items-center"><i class="far fa-calendar mr-1"></i>${
                  devoir.date_rendu
                    ? new Date(devoir.date_rendu).toLocaleDateString("fr-FR")
                    : "N/A"
                }</span>
                <span class="flex items-center"><i class="far fa-clock mr-1"></i>${
                  devoir.jours_restants
                } jours</span>
              </div>
            </div>
          </div>
        </div>`;
      })
      .join("");
  }

  function renderMatieiresFaibles(matieres) {
    const container = document.getElementById("matieres-faibles");
    if (matieres.length === 0) {
      container.innerHTML = `
        <div class="text-center py-6 sm:py-8">
          <i class="fas fa-trophy text-yellow-500 text-3xl sm:text-4xl mb-2 sm:mb-3"></i>
          <p class="text-gray-600 text-xs sm:text-sm">Toutes vos matières sont au-dessus de 12/20 !</p>
        </div>`;
      return;
    }

    container.innerHTML = matieres
      .slice(0, 3)
      .map((matiere) => {
        const colorClass =
          matiere.moyenne < 8
            ? "bg-red-100 text-red-800"
            : matiere.moyenne < 10
            ? "bg-orange-100 text-orange-800"
            : "bg-yellow-100 text-yellow-800";
        return `
        <div class="border border-gray-200 rounded-lg p-3 sm:p-4 hover:shadow-md transition-all duration-200 card-hover">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold text-gray-900 text-xs sm:text-sm truncate pr-2">${
              matiere.matiere
            }</h4>
            <span class="${colorClass} text-xs px-2 py-1 rounded-full font-semibold whitespace-nowrap">${
          matiere.moyenne
        }/20</span>
          </div>
          <div class="flex items-center justify-between text-xs text-gray-500">
            <span class="truncate pr-2">${matiere.niveau_difficulte}</span>
            <span class="whitespace-nowrap">Priorité: ${Math.round(
              matiere.priorite
            )}/100</span>
          </div>
        </div>`;
      })
      .join("");
  }

  // ==================== RECOMMANDATIONS AI ====================
  async function loadRecommendations() {
    const container = document.getElementById("recommendations");
    container.innerHTML = `
      <div class="flex items-center justify-center py-6 sm:py-8">
        <div class="animate-spin rounded-full h-10 w-10 sm:h-12 sm:w-12 border-b-2 border-indigo-600 mr-3 sm:mr-4"></div>
        <span class="text-gray-600 text-sm sm:text-base">Génération des recommandations IA...</span>
      </div>`;

    try {
      const response = await fetch("/study-planner/api/recommendations");
      const result = await response.json();
      if (result.success && result.data) {
        renderRecommendations(result.data);
      } else {
        container.innerHTML = `
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 sm:p-4">
            <div class="flex">
              <i class="fas fa-exclamation-triangle text-yellow-600 text-lg sm:text-xl mt-1 mr-2 sm:mr-3 flex-shrink-0"></i>
              <div>
                <h4 class="font-semibold text-yellow-900 mb-1 text-sm sm:text-base">Service IA temporairement indisponible</h4>
                <p class="text-xs sm:text-sm text-yellow-800">Les recommandations ne peuvent pas être générées. Réessayez plus tard.</p>
              </div>
            </div>
          </div>`;
      }
    } catch (error) {
      console.error("Error loading recommendations:", error);
      container.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex">
                    <i class="fas fa-times-circle text-red-600 text-xl mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-semibold text-red-900 mb-1">Erreur de connexion</h4>
                        <p class="text-sm text-red-800">Impossible de charger les recommandations. Vérifiez votre connexion internet.</p>
                    </div>
                </div>
            </div>
        `;
    }
  }

  function renderRecommendations(recommendations) {
    const container = document.getElementById("recommendations");

    if (!Array.isArray(recommendations) || recommendations.length === 0) {
      container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-check-circle text-green-500 text-4xl mb-3"></i>
                <p class="text-gray-600">Vous êtes sur la bonne voie !</p>
            </div>
        `;
      return;
    }

    container.innerHTML = recommendations
      .map((rec) => {
        const iconColor =
          rec.type === "critique"
            ? "text-red-600"
            : rec.type === "warning"
            ? "text-yellow-600"
            : rec.type === "success"
            ? "text-green-600"
            : "text-blue-600";

        const bgColor =
          rec.type === "critique"
            ? "bg-red-50 border-red-200"
            : rec.type === "warning"
            ? "bg-yellow-50 border-yellow-200"
            : rec.type === "success"
            ? "bg-green-50 border-green-200"
            : "bg-blue-50 border-blue-200";

        const actionsHTML =
          rec.actions && Array.isArray(rec.actions)
            ? `
            <ul class="space-y-2 mt-3">
                ${rec.actions
                  .map(
                    (action) => `
                    <li class="text-sm text-gray-700 flex items-start">
                        <i class="fas fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                        <span>${action}</span>
                    </li>
                `
                  )
                  .join("")}
            </ul>
        `
            : "";

        return `
            <div class="border ${bgColor} rounded-lg p-5 hover:shadow-md transition-shadow">
                <div class="flex">
                    <i class="${
                      rec.icon || "fas fa-info-circle"
                    } ${iconColor} text-2xl mt-1 mr-4 flex-shrink-0"></i>
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-900 mb-2 text-lg">${
                          rec.title || "Recommandation"
                        }</h4>
                        <p class="text-sm text-gray-700 leading-relaxed">${
                          rec.message || ""
                        }</p>
                        ${actionsHTML}
                    </div>
                </div>
            </div>
        `;
      })
      .join("");
  }

  // ==================== MODAL FUNCTIONS ====================
  function openGeneratePlanModal() {
    document.getElementById("generate-plan-modal").classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
  }

  function closeGeneratePlanModal() {
    document.getElementById("generate-plan-modal").classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
  }

  function setDefaultDates() {
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(today.getDate() + 7);

    document.getElementById("start-date").valueAsDate = today;
    document.getElementById("end-date").valueAsDate = nextWeek;
  }

  function updateStudyHoursLabel() {
    const hours = document.getElementById("study-hours").value;
    document.getElementById("study-hours-label").textContent = `${hours}h`;
  }

  // ==================== FORM SUBMISSION ====================
  document
    .getElementById("generate-plan-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const startDate = document.getElementById("start-date").value;
      const endDate = document.getElementById("end-date").value;
      const studyHours = document.getElementById("study-hours").value;

      // Show loading in button
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalHTML = submitBtn.innerHTML;
      submitBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin mr-2"></i>Génération en cours...';
      submitBtn.disabled = true;

      try {
        const csrfToken =
          document
            .querySelector('meta[name="csrf-token"]')
            ?.getAttribute("content") || "";

        const response = await fetch("/study-planner/api/generate-plan", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify({
            start_date: startDate,
            end_date: endDate,
            study_hours_per_day: parseInt(studyHours),
            focus_areas: [],
          }),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
          window.location.href =
            "/study-planner/view-plan?data=" +
            encodeURIComponent(JSON.stringify(result.data));
        } else {
          alert("Erreur: " + result.error);
        }
      } catch (error) {
        console.error("Error generating plan:", error);
        alert("Erreur lors de la génération du plan: " + error.message);
      } finally {
        submitBtn.innerHTML = originalHTML;
        submitBtn.disabled = false;
      }
    });

  function refreshDashboard() {
    loadDashboard();
  }

  function showError(message) {
    alert(message);
  }
</script>

{% endblock %}
