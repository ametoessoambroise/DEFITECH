{% extends "base.html" %}
{% block title %}Modifier le rapport de bug - DEFITECH{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50/20 to-slate-50 py-6 sm:py-8 lg:py-12">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Navigation -->
    <div class="mb-6">
      <a href="{{ url_for('bug_reports.view_bug_report', report_id=bug_report.id) }}"
        class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>
        Retour au rapport
      </a>
    </div>

    <!-- En-tête -->
    <div class="mb-6 sm:mb-8">
      <div class="flex flex-col space-y-2">
        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 flex items-center">
          <span
            class="flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-blue-100 text-blue-600 mr-3 sm:mr-4">
            <i class="fas fa-edit text-lg sm:text-xl"></i>
          </span>
          Modifier le rapport
        </h1>
        <p class="text-sm sm:text-base text-gray-600 ml-0 lg:ml-16">
          Mettez à jour les informations de ce rapport de bug
        </p>
      </div>
    </div>

    <!-- Formulaire principal -->
    <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
      <div class="bg-gradient-to-r from-gray-50 to-white px-4 sm:px-6 py-5 border-b border-gray-200">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-900">
          <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>
          Détails du bug
        </h2>
        <p class="mt-1 text-sm text-gray-600">
          Modifiez les informations nécessaires ci-dessous
        </p>
      </div>

      <form method="POST" enctype="multipart/form-data" class="divide-y divide-gray-100">
        {{ form.hidden_tag() }}

        <!-- Titre -->
        <div class="px-4 sm:px-6 py-5 space-y-3">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.title.label.text }}
            <span class="text-red-500">*</span>
          </label>
          {{ form.title(class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-2
          focus:ring-blue-500/20 sm:text-sm transition-all") }}
          {% if form.title.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.title.errors[0] }}
          </p>
          {% endif %}
        </div>

        <!-- Description -->
        <div class="px-4 sm:px-6 py-5 space-y-3 bg-gray-50/50">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.description.label.text }}
            <span class="text-red-500">*</span>
          </label>
          {{ form.description(class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500
          focus:ring-2 focus:ring-blue-500/20 sm:text-sm transition-all min-h-[120px]") }}
          {% if form.description.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.description.errors[0] }}
          </p>
          {% endif %}
        </div>

        <!-- Étapes pour reproduire -->
        <div class="px-4 sm:px-6 py-5 space-y-3">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.steps_to_reproduce.label.text }}
            <span class="text-red-500">*</span>
          </label>
          {{ form.steps_to_reproduce(class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500
          focus:ring-2 focus:ring-blue-500/20 sm:text-sm transition-all min-h-[120px]") }}
          {% if form.steps_to_reproduce.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.steps_to_reproduce.errors[0] }}
          </p>
          {% endif %}
        </div>

        <!-- Priorité -->
        <div class="px-4 sm:px-6 py-5 space-y-3 bg-gray-50/50">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.priority.label.text }}
            <span class="text-red-500">*</span>
          </label>
          {{ form.priority(class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-2
          focus:ring-blue-500/20 sm:text-sm transition-all") }}
          {% if form.priority.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.priority.errors[0] }}
          </p>
          {% endif %}
        </div>

        <!-- Statut (admin uniquement) -->
        {% if current_user.role == 'admin' %}
        <div class="px-4 sm:px-6 py-5 space-y-3">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.status.label.text }}
            <span
              class="inline-flex items-center ml-2 px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
              Admin
            </span>
          </label>
          {{ form.status(class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-2
          focus:ring-blue-500/20 sm:text-sm transition-all") }}
          {% if form.status.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.status.errors[0] }}
          </p>
          {% endif %}
        </div>
        {% endif %}

        <!-- Capture d'écran actuelle -->
        {% if bug_report.image_path %}
        <div class="px-4 sm:px-6 py-5 space-y-4 bg-gray-50/50">
          <label class="block text-sm font-semibold text-gray-900">
            Capture d'écran actuelle
          </label>

          <div class="relative inline-block group">
            <img src="{{ url_for('static', filename=bug_report.image_path) }}" alt="Capture d'écran actuelle"
              class="h-40 w-auto rounded-xl border-2 border-gray-200 shadow-md transition-transform group-hover:scale-105" />
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all rounded-xl">
            </div>
          </div>

          <div class="flex items-center p-4 bg-white rounded-xl border border-gray-200">
            <input id="remove_image" name="remove_image" type="checkbox"
              class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded transition-all" />
            <label for="remove_image" class="ml-3 flex items-center text-sm text-gray-700 cursor-pointer">
              <i class="fas fa-trash-alt text-red-500 mr-2"></i>
              <span>Supprimer cette capture d'écran</span>
            </label>
          </div>
        </div>
        {% endif %}

        <!-- Nouvelle capture d'écran -->
        <div class="px-4 sm:px-6 py-5 space-y-3">
          <label class="block text-sm font-semibold text-gray-900">
            {{ 'Remplacer par une nouvelle capture' if bug_report.image_path else 'Capture d\'écran' }}
            <span class="text-gray-500 text-xs font-normal ml-1">(optionnel)</span>
          </label>

          <div
            class="mt-1 flex justify-center px-6 pt-8 pb-8 border-2 border-gray-300 border-dashed rounded-xl hover:border-blue-400 transition-all bg-gray-50/50 hover:bg-blue-50/50"
            id="drop-area">
            <div class="space-y-2 text-center">
              <svg class="mx-auto h-14 w-14 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"
                aria-hidden="true">
                <path
                  d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <div class="flex flex-col sm:flex-row text-sm text-gray-600 justify-center items-center">
                <label for="screenshot"
                  class="relative cursor-pointer rounded-md font-semibold text-blue-600 hover:text-blue-700 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500 transition-colors">
                  <span>Télécharger un fichier</span>
                  {{ form.screenshot(class="sr-only") }}
                </label>
                <p class="pl-1">ou glisser-déposer</p>
              </div>
              <p class="text-xs text-gray-500">PNG, JPG, GIF jusqu'à 5MB</p>
            </div>
          </div>

          {% if form.screenshot.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.screenshot.errors[0] }}
          </p>
          {% endif %}
        </div>

        <!-- Notes admin -->
        {% if current_user.role == 'admin' %}
        <div class="px-4 sm:px-6 py-5 space-y-3 bg-gradient-to-r from-blue-50/50 to-indigo-50/50">
          <label class="block text-sm font-semibold text-gray-900">
            {{ form.admin_notes.label.text }}
            <span
              class="inline-flex items-center ml-2 px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
              <i class="fas fa-lock mr-1"></i>
              Admin uniquement
            </span>
          </label>
          {{ form.admin_notes(class="block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500
          focus:ring-2 focus:ring-blue-500/20 sm:text-sm transition-all min-h-[100px]",
          placeholder="Notes internes visibles uniquement par les administrateurs...") }}
          {% if form.admin_notes.errors %}
          <p class="mt-2 text-sm text-red-600 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ form.admin_notes.errors[0] }}
          </p>
          {% endif %}
          <p class="text-xs text-blue-700 flex items-start">
            <i class="fas fa-info-circle mr-2 mt-0.5"></i>
            <span>Ces notes sont confidentielles et ne sont visibles que par les administrateurs</span>
          </p>
        </div>
        {% endif %}

        <!-- Boutons d'action -->
        <div
          class="px-4 sm:px-6 py-4 bg-gradient-to-r from-gray-50 to-white flex flex-col-reverse sm:flex-row sm:justify-between gap-3">
          <a href="{{ url_for('bug_reports.view_bug_report', report_id=bug_report.id) }}"
            class="inline-flex justify-center items-center px-5 py-2.5 border border-gray-300 shadow-sm text-sm font-medium rounded-xl text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all">
            <i class="fas fa-times mr-2"></i>
            Annuler
          </a>

          <button type="submit"
            class="inline-flex justify-center items-center px-6 py-2.5 border border-transparent shadow-lg text-sm font-medium rounded-xl text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform hover:scale-105">
            <i class="fas fa-save mr-2"></i>
            Enregistrer les modifications
          </button>
        </div>
      </form>
    </div>

    <!-- Zone dangereuse -->
    {% if current_user.id == bug_report.user_id or current_user.role == 'admin' %}
    <div class="mt-8 bg-white shadow-xl rounded-2xl overflow-hidden border border-red-200">
      <div class="bg-gradient-to-r from-red-50 to-pink-50 px-4 sm:px-6 py-5 border-b border-red-200">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="flex items-center justify-center h-10 w-10 rounded-xl bg-red-100 text-red-600">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
          <div class="ml-4">
            <h2 class="text-lg font-semibold text-red-800">Zone dangereuse</h2>
            <p class="mt-1 text-sm text-red-600">
              Les actions dans cette section sont irréversibles
            </p>
          </div>
        </div>
      </div>

      <div class="px-4 sm:px-6 py-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div class="flex-1">
            <h3 class="text-sm font-semibold text-gray-900 mb-1">
              Supprimer ce rapport de bug
            </h3>
            <p class="text-sm text-gray-600">
              Cette action est définitive et supprimera toutes les données associées
            </p>
          </div>

          <button type="button" onclick="confirmDelete()"
            class="inline-flex items-center justify-center px-5 py-2.5 border border-transparent text-sm font-medium rounded-xl text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all transform hover:scale-105 shadow-lg">
            <i class="fas fa-trash-alt mr-2"></i>
            Supprimer définitivement
          </button>
        </div>
      </div>
    </div>

    <form id="delete-form" action="{{ url_for('bug_reports.delete_bug_report', report_id=bug_report.id) }}"
      method="POST" class="hidden">
      <input type="hidden" name="_method" value="DELETE" />
    </form>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Gestion de l'aperçu d'image
  const screenshotInput = document.getElementById('screenshot');
  const dropArea = document.getElementById('drop-area');

  screenshotInput.addEventListener('change', handleFileSelect);

  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        alert('Le fichier est trop volumineux. Maximum 5MB.');
        screenshotInput.value = '';
        return;
      }

      const reader = new FileReader();
      const container = dropArea.querySelector('.space-y-2');

      reader.onload = function (e) {
        const oldPreview = dropArea.querySelector('.image-preview');
        if (oldPreview) oldPreview.remove();

        const preview = document.createElement('div');
        preview.className = 'image-preview mt-4';
        preview.innerHTML = `
          <div class="relative inline-block group">
            <img src="${e.target.result}" alt="Aperçu" 
                 class="max-h-48 w-auto rounded-xl border-2 border-gray-200 shadow-lg">
            <button type="button" 
                    class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-2 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 shadow-lg transition-all transform hover:scale-110"
                    onclick="removePreview()">
              <i class="fas fa-times text-sm"></i>
            </button>
          </div>
        `;

        container.appendChild(preview);
        container.querySelectorAll('svg, .flex, p.text-xs').forEach(el => el.style.display = 'none');
      };

      reader.readAsDataURL(file);
    }
  }

  function removePreview() {
    screenshotInput.value = '';
    const preview = dropArea.querySelector('.image-preview');
    if (preview) preview.remove();

    const container = dropArea.querySelector('.space-y-2');
    container.querySelectorAll('svg, .flex, p.text-xs').forEach(el => el.style.display = '');
  }

  // Drag & Drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, e => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  ['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => {
      dropArea.classList.add('border-blue-500', 'bg-blue-100');
    });
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => {
      dropArea.classList.remove('border-blue-500', 'bg-blue-100');
    });
  });

  dropArea.addEventListener('drop', e => {
    const files = e.dataTransfer.files;
    if (files.length) {
      screenshotInput.files = files;
      handleFileSelect({ target: { files } });
    }
  });

  // Confirmation de suppression
  function confirmDelete() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
      <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl animate-fadeIn">
        <div class="flex items-center mb-4">
          <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-xl bg-red-100 text-red-600">
            <i class="fas fa-exclamation-triangle text-xl"></i>
          </div>
          <h3 class="ml-4 text-lg font-semibold text-gray-900">Confirmer la suppression</h3>
        </div>
        <p class="text-sm text-gray-600 mb-6">
          Êtes-vous sûr de vouloir supprimer ce rapport de bug ? Cette action est irréversible et toutes les données associées seront perdues.
        </p>
        <div class="flex justify-end space-x-3">
          <button onclick="this.closest('.fixed').remove()" 
                  class="px-4 py-2 border border-gray-300 rounded-xl text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-all">
            Annuler
          </button>
          <button onclick="document.getElementById('delete-form').submit()" 
                  class="px-4 py-2 border border-transparent rounded-xl text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition-all">
            Supprimer définitivement
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }

    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-fadeIn {
    animation: fadeIn 0.2s ease-out;
  }
</style>
{% endblock %}