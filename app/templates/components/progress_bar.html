<!-- Barre de progression pour les navigations -->
<div id="progressBarContainer" class="fixed top-0 left-0 w-full h-1 bg-gray-200 z-[99999] hidden">
    <div id="progressBar" class="h-full bg-blue-500 transition-all duration-300 ease-out" style="width: 0%"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');

        if (!progressBarContainer || !progressBar) return;

        let progressInterval;
        let currentProgress = 0;
        let networkTimeout;
        let navigationStartTime;
        let maxWaitTime = 15000; // 15 secondes max avant de rediriger vers offline

        function startProgress() {
            // Réinitialiser
            currentProgress = 0;
            progressBar.style.width = '0%';
            progressBarContainer.classList.remove('hidden');
            navigationStartTime = Date.now();

            // Progression basée sur le réseau et le temps
            progressInterval = setInterval(() => {
                const elapsedTime = Date.now() - navigationStartTime;
                const progressFactor = Math.min(elapsedTime / maxWaitTime, 1);
                
                // Progression exponentielle qui ralentit vers la fin
                if (currentProgress < 95) {
                    // Commence rapide, puis ralentit progressivement
                    const baseIncrement = Math.random() * 8 + 2; // 2-10%
                    const slowdownFactor = Math.pow(1 - progressFactor, 2); // Ralentissement exponentiel
                    const increment = baseIncrement * slowdownFactor;
                    
                    currentProgress += increment;
                    if (currentProgress > 95) currentProgress = 95;
                    
                    progressBar.style.width = currentProgress + '%';
                    
                    // Changer de couleur quand ça prend du temps
                    if (progressFactor > 0.5) {
                        progressBar.className = 'h-full bg-orange-500 transition-all duration-300 ease-out';
                    }
                    if (progressFactor > 0.8) {
                        progressBar.className = 'h-full bg-red-500 transition-all duration-300 ease-out';
                    }
                }
            }, 200);
            
            // Timeout en cas de réponse trop longue
            networkTimeout = setTimeout(() => {
                hideProgress();
            }, maxWaitTime);
        }

        function completeProgress(callback) {
            clearInterval(progressInterval);
            clearTimeout(networkTimeout);
            currentProgress = 100;
            progressBar.style.width = '100%';
            progressBar.className = 'h-full bg-green-500 transition-all duration-300 ease-out';

            // Rediriger après un court délai
            setTimeout(() => {
                progressBarContainer.classList.add('hidden');
                if (callback) callback();
            }, 200);
        }

        function hideProgress() {
            clearInterval(progressInterval);
            clearTimeout(networkTimeout);
            progressBarContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            progressBar.className = 'h-full bg-blue-500 transition-all duration-300 ease-out';
            currentProgress = 0;
        }

        function handleOffline() {
            hideProgress();
        }

        // Vérifier la connectivité réseau
        function checkConnectivity() {
            return fetch('/api/health', {
                method: 'HEAD',
                cache: 'no-cache',
                timeout: 5000
            }).then(response => {
                return response.ok;
            }).catch(() => {
                return false;
            });
        }

        // Intercepter tous les clics sur les liens
        document.addEventListener('click', function (e) {
            const target = e.target.closest('a[href]');
            if (!target) return;

            const href = target.getAttribute('href');

            // Ignorer les liens spéciaux
            if (href.startsWith('#') ||
                href.startsWith('javascript:') ||
                href.startsWith('mailto:') ||
                href.startsWith('tel:') ||
                target.hasAttribute('target') ||
                target.hasAttribute('download') ||
                e.ctrlKey || e.metaKey || e.shiftKey) {
                return;
            }

            // Vérifier si on est déjà hors ligne
            if (!navigator.onLine) {
                e.preventDefault();
                handleOffline();
                return;
            }

            // Empêcher la navigation par défaut
            e.preventDefault();

            // Démarrer la progression
            startProgress();

            // Vérifier la connectivité et naviguer
            Promise.race([
                checkConnectivity(),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), maxWaitTime))
            ]).then(isConnected => {
                if (isConnected) {
                    // Navigation réussie
                    completeProgress(() => {
                        window.location.href = href;
                    });
                } else {
                    // Problème de connectivité
                    handleOffline();
                }
            }).catch(() => {
                // Timeout ou erreur réseau
                handleOffline();
            });
        });

        // Gérer les soumissions de formulaire
        document.addEventListener('submit', function (e) {
            const form = e.target;
            if (!form || !form.action) return;

            // Vérifier si on est hors ligne
            if (!navigator.onLine) {
                e.preventDefault();
                handleOffline();
                return;
            }

            startProgress();
        });

        // Nettoyer en cas de chargement de page réussi
        window.addEventListener('load', function () {
            hideProgress();
        });

        // Cacher la barre si la navigation est annulée
        window.addEventListener('popstate', function () {
            hideProgress();
        });

        // Gérer les changements de connectivité pendant la navigation
        window.addEventListener('offline', function () {
            if (progressBarContainer && !progressBarContainer.classList.contains('hidden')) {
                handleOffline();
            }
        });

        // Exposer les fonctions globalement si besoin
        window.progressBar = {
            start: startProgress,
            complete: completeProgress,
            hide: hideProgress
        };
    });
</script>