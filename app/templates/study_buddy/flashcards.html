{% extends "study_buddy/base.html" %}

{% block title %}Cartes Mémoire - StudyBuddy{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 max-w-7xl">
    <!-- En-tête -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4 mb-6 sm:mb-8">
        <div>
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-800">Mes Cartes Mémoire</h1>
            <p class="mt-2 text-sm sm:text-base text-gray-600">Créez et révisez vos cartes pour mémoriser efficacement
            </p>
        </div>
        <div class="flex gap-2 sm:gap-3 w-full sm:w-auto">
            <button id="createCardBtn"
                class="flex-1 sm:flex-none px-4 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-all shadow-sm flex items-center justify-center">
                <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Nouvelle Carte
            </button>
            <button id="studyBtn"
                class="flex-1 sm:flex-none px-4 py-2.5 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-all shadow-sm flex items-center justify-center">
                <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <span class="hidden sm:inline">Étudier</span>
                <span class="sm:hidden">Réviser</span>
            </button>
        </div>
    </div>

    <!-- Formulaire de création/édition de carte -->
    <div id="cardFormContainer" class="hidden bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6 sm:mb-8 animate-fadeIn">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-700 mb-4 sm:mb-6" id="formTitle">Nouvelle Carte</h2>
        <form id="flashcardForm">
            <input type="hidden" id="cardId">

            <!-- Deck -->
            <div class="mb-4 sm:mb-5">
                <label for="deck" class="block text-sm font-medium text-gray-700 mb-2">
                    Deck <span class="text-red-500">*</span>
                </label>
                <select id="deck" name="deck" required
                    class="mt-1 block w-full pl-3 pr-10 py-2.5 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 rounded-lg transition-colors">
                    {% for deck in decks %}
                    <option value="{{ deck.id }}">{{ deck.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Question -->
            <div class="mb-4 sm:mb-5">
                <label for="front" class="block text-sm font-medium text-gray-700 mb-2">
                    Question <span class="text-red-500">*</span>
                </label>
                <textarea id="front" name="front" rows="3" required
                    class="shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block w-full text-sm sm:text-base border-gray-300 rounded-lg p-3 transition-colors resize-none"
                    placeholder="Entrez la question ou le terme à mémoriser"></textarea>
                <p class="mt-1 text-xs text-gray-500">Soyez clair et concis</p>
            </div>

            <!-- Réponse -->
            <div class="mb-5 sm:mb-6">
                <label for="back" class="block text-sm font-medium text-gray-700 mb-2">
                    Réponse <span class="text-red-500">*</span>
                </label>
                <textarea id="back" name="back" rows="4" required
                    class="shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block w-full text-sm sm:text-base border-gray-300 rounded-lg p-3 transition-colors resize-none"
                    placeholder="Entrez la réponse ou la définition"></textarea>
                <p class="mt-1 text-xs text-gray-500">Fournissez une réponse complète et précise</p>
            </div>

            <!-- Boutons -->
            <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-2 sm:gap-3">
                <button type="button" id="cancelBtn"
                    class="w-full sm:w-auto px-5 py-2.5 border-2 border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    Annuler
                </button>
                <button type="submit"
                    class="w-full sm:w-auto px-5 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors shadow-sm">
                    Enregistrer
                </button>
            </div>
        </form>
    </div>

    <!-- Liste des cartes -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
        {% for card in flashcards %}
        <div
            class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4 sm:p-6">
                <!-- En-tête avec deck et actions -->
                <div class="flex justify-between items-start mb-4">
                    <span
                        class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 truncate max-w-[70%]">
                        {{ card.deck_name }}
                    </span>
                    <div class="flex gap-2">
                        <button
                            class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-1.5 rounded-lg transition-colors"
                            onclick="editCard('{{ card.id }}')" aria-label="Modifier">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <button
                            class="text-red-600 hover:text-red-800 hover:bg-red-50 p-1.5 rounded-lg transition-colors"
                            onclick="deleteCard('{{ card.id }}')" aria-label="Supprimer">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Contenu -->
                <div class="mb-4">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2 line-clamp-2">{{ card.front }}</h3>
                    <div class="text-gray-600 text-sm line-clamp-3">
                        {{ card.back }}
                    </div>
                </div>

                <!-- Barre de progression -->
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex items-center text-xs sm:text-sm text-gray-500 mb-2">
                        <span class="font-medium">Maîtrise: </span>
                        <div class="ml-2 flex-1 bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div class="bg-gradient-to-r from-green-500 to-green-600 h-2 rounded-full transition-all duration-300"
                                style="width: {{ card.mastery }}%"></div>
                        </div>
                        <span class="ml-2 font-semibold text-green-600">{{ card.mastery }}%</span>
                    </div>
                    <div class="text-xs text-gray-400 flex items-center">
                        <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Dernière révision: {{ card.last_reviewed|datetimeformat('%d/%m/%Y') if card.last_reviewed else
                        'Jamais' }}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- État vide -->
        <div class="col-span-full text-center py-12 sm:py-16">
            <div
                class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-gray-100 mb-4">
                <svg class="h-8 w-8 sm:h-10 sm:w-10 text-gray-400" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
            </div>
            <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-1">Aucune carte mémoire</h3>
            <p class="text-sm text-gray-500 mb-6 px-4">Commencez par créer votre première carte pour démarrer
                l'apprentissage.</p>
            <button id="startCreatingBtn"
                class="inline-flex items-center px-5 py-2.5 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                        clip-rule="evenodd" />
                </svg>
                Créer une carte
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Modal de confirmation de suppression -->
    <div id="deleteModal" class="hidden fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- Overlay -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <!-- Centre le modal -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <!-- Contenu du modal -->
            <div
                class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Supprimer la carte</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Êtes-vous sûr de vouloir supprimer cette carte ? Cette
                                action est irréversible.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse gap-2 sm:gap-3">
                    <button type="button" id="confirmDeleteBtn"
                        class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:w-auto sm:text-sm transition-colors">
                        Supprimer
                    </button>
                    <button type="button" id="cancelDeleteBtn"
                        class="mt-3 w-full inline-flex justify-center rounded-lg border-2 border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm transition-colors">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Gestion de l'affichage du formulaire et des interactions
    document.addEventListener('DOMContentLoaded', function () {
        const createCardBtn = document.getElementById('createCardBtn');
        const startCreatingBtn = document.getElementById('startCreatingBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const cardFormContainer = document.getElementById('cardFormContainer');
        const flashcardForm = document.getElementById('flashcardForm');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        let cardToDelete = null;

        // Afficher le formulaire de création
        function showForm() {
            document.getElementById('formTitle').textContent = 'Nouvelle Carte';
            document.getElementById('cardId').value = '';
            flashcardForm.reset();
            cardFormContainer.classList.remove('hidden');
            cardFormContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Cacher le formulaire
        function hideForm() {
            cardFormContainer.classList.add('hidden');
        }

        // Afficher la modale de suppression
        window.deleteCard = function (cardId) {
            cardToDelete = cardId;
            deleteModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Empêche le scroll
        };

        // Cacher la modale de suppression
        function hideDeleteModal() {
            deleteModal.classList.add('hidden');
            document.body.style.overflow = ''; // Réactive le scroll
            cardToDelete = null;
        }

        // Gestion des événements
        if (createCardBtn) createCardBtn.addEventListener('click', showForm);
        if (startCreatingBtn) startCreatingBtn.addEventListener('click', showForm);
        if (cancelBtn) cancelBtn.addEventListener('click', hideForm);
        if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', hideDeleteModal);

        // Fermer le modal en cliquant sur l'overlay
        if (deleteModal) {
            deleteModal.addEventListener('click', function (e) {
                if (e.target === deleteModal) {
                    hideDeleteModal();
                }
            });
        }

        // Fonction utilitaire pour les requêtes API
        async function fetchAPI(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                credentials: 'same-origin'
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`/api/flashcards${endpoint}`, options);
                if (!response.ok) {
                    throw new Error('Erreur réseau');
                }
                return await response.json();
            } catch (error) {
                console.error('Erreur API:', error);
                showError('Une erreur est survenue lors de la communication avec le serveur');
                throw error;
            }
        }

        // Soumission du formulaire
        if (flashcardForm) {
            flashcardForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Désactiver le bouton de soumission
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Enregistrement...';

                try {
                    // Validation des champs
                    const front = document.getElementById('front').value.trim();
                    const back = document.getElementById('back').value.trim();
                    const deckId = document.getElementById('deck').value;

                    if (!front || !back || !deckId) {
                        throw new Error('Veuillez remplir tous les champs obligatoires.');
                    }

                    // Préparation des données
                    const cardData = {
                        front: front,
                        back: back,
                        deck_id: deckId
                    };

                    const cardId = document.getElementById('cardId').value;
                    let response;

                    // Création ou mise à jour
                    if (cardId) {
                        response = await fetchAPI(`/${cardId}`, 'PUT', cardData);
                        showSuccess('Carte mise à jour avec succès !');
                    } else {
                        response = await fetchAPI('', 'POST', cardData);
                        showSuccess('Carte créée avec succès !');
                    }

                    // Recharger la page pour voir les changements
                    window.location.reload();

                } catch (error) {
                    showError(error.message || 'Erreur lors de l\'enregistrement de la carte');
                    console.error('Erreur:', error);
                } finally {
                    // Réactiver le bouton
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });
        }

        // Confirmation de suppression
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', async function () {
                if (!cardToDelete) return;

                const deleteBtn = this;
                const originalBtnText = deleteBtn.innerHTML;
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = 'Suppression...';

                try {
                    await fetchAPI(`/${cardToDelete}`, 'DELETE');
                    showSuccess('Carte supprimée avec succès !');

                    // Supprimer visuellement la carte ou recharger la page
                    const cardElement = document.querySelector(`[data-card-id="${cardToDelete}"]`);
                    if (cardElement) {
                        cardElement.remove();

                        // Vérifier s'il reste des cartes
                        const remainingCards = document.querySelectorAll('[data-card-id]').length;
                        if (remainingCards === 0) {
                            window.location.reload();
                        }
                    } else {
                        window.location.reload();
                    }
                } catch (error) {
                    showError('Erreur lors de la suppression de la carte');
                    console.error('Erreur:', error);
                } finally {
                    hideDeleteModal();
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalBtnText;
                    cardToDelete = null;
                }
            });
        }

        // Édition d'une carte existante
        window.editCard = async function (cardId) {
            try {
                const cardData = await fetchAPI(`/${cardId}`);

                if (!cardData) {
                    throw new Error('Impossible de charger les données de la carte');
                }

                document.getElementById('formTitle').textContent = 'Modifier la Carte';
                document.getElementById('cardId').value = cardData.id;
                document.getElementById('deck').value = cardData.deck_id;
                document.getElementById('front').value = cardData.front;
                document.getElementById('back').value = cardData.back;

                cardFormContainer.classList.remove('hidden');
                cardFormContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                showError('Erreur lors du chargement de la carte');
                console.error('Erreur:', error);
            }
        };

        // Système de notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'
                } transition-all duration-300 transform translate-x-0 opacity-100`;
            toast.role = 'alert';

            const messageEl = document.createElement('div');
            messageEl.className = 'flex items-center';

            const icon = document.createElement('span');
            icon.className = 'mr-2';
            icon.innerHTML = type === 'success' ?
                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';

            messageEl.appendChild(icon);
            messageEl.appendChild(document.createTextNode(message));
            toast.appendChild(messageEl);

            document.body.appendChild(toast);

            // Animation d'entrée
            setTimeout(() => {
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 10);

            // Suppression après délai
            setTimeout(() => {
                toast.classList.remove('translate-x-0', 'opacity-100');
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }

        // Fonctions utilitaires pour les messages
        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showError(message) {
            showToast(message, 'error');
        }

        // Gestion du bouton "Étudier"
        const studyBtn = document.getElementById('studyBtn');
        if (studyBtn) {
            studyBtn.addEventListener('click', function () {
                // Vérifier s'il y a des cartes à étudier
                const hasCards = document.querySelectorAll('[data-card-id]').length > 0;

                if (!hasCards) {
                    showError('Aucune carte à étudier. Créez d\'abord des cartes.');
                    return;
                }

                // Rediriger vers la page d'étude
                window.location.href = '{{ url_for("study_buddy.flashcard_deck") }}';
            });
        }
    });
</script>
{% endblock %}
{% endblock %}